name: Build

on: [push, pull_request]

jobs:

  validate-data:
    name: Validate Metadata
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Create Build Environment
      run: cd .github/workflows/ && podman build -t intanrhx_validate -f ./Dockerfile-debian-testing .

    - name: Validate
      run: podman run -t -v `pwd`:/build intanrhx_validate
           appstreamcli validate contrib/com.intantech.intan_rhx.metainfo.xml


  build-debian:
    name: Debian Stable
    runs-on: ubuntu-latest

    env:
      SUITE: bullseye
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Install Prerequisites
      run: sudo apt-get -yq install debspawn

    - name: Create Build Environment
      run: debspawn create ${{ env.SUITE }}

    - name: Build
      run: ./contrib/ci/auto-build-deb.sh ${{ env.SUITE }}

    - name: Upload Debian package artifact
      uses: actions/upload-artifact@v2
      with:
        name: Debian Package
        path: |
          result/*.deb
          result/*.buildinfo


  build-ubuntu:
    name: Ubuntu LTS
    runs-on: ubuntu-latest

    env:
      SUITE: focal
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Install Prerequisites
      run: sudo apt-get -yq install debspawn

    - name: Create Build Environment
      run: debspawn create ${{ env.SUITE }}

    - name: Build
      run: ./contrib/ci/auto-build-deb.sh ${{ env.SUITE }}

    - name: Upload Ubuntu package artifact
      uses: actions/upload-artifact@v2
      with:
        name: Ubuntu Package
        path: |
          result/*.deb
          result/*.buildinfo
